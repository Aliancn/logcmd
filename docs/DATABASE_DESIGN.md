# LogCmd 数据库设计概要

本概要仅关注系统必须具备的核心能力和数据结构，用于指导实现与评审，不包含具体代码细节。

## 设计目标
- **统一元数据**：命令执行信息、项目属性、统计结果全部进入 SQLite，日志文件继续存放原始输出。
- **极致查询性能**：任意时间范围、命令类别、状态的检索都必须避免扫描日志文件。
- **可演化结构**：所有表保留 JSON 字段以容纳未来配置或标签扩展，遵循向后兼容。
- **自动迁移**：程序启动即可检测旧版本 `logcmd_entries` 并迁移为新结构，不需要用户干预。

## 关键表

| 表名 | 作用 | 重点字段 |
|------|------|----------|
| `projects` | 记录每个 `.logcmd` 目录的静态信息与汇总指标 | 路径、名称、标签、总命令数、成功/失败数、总耗时、最后命令状态、模板配置 |
| `command_history` | 记录每次命令执行 | 项目 ID、命令/参数、起止时间、耗时、退出码、状态、关联日志路径、输出预览、运行环境 |
| `project_stats_cache` | 缓存按日期聚合的统计 | 项目 ID、统计日期、日度命令数、成功率、耗时统计、命令/退出码分布 JSON |
| `system_config` | 保存系统级参数 | 键值对（JSON），用于记录版本号、保留策略等 |
| `tags` / `project_tags`（可选） | 管理标签的元信息及项目关联 | 标签展示属性与引用计数，项目与标签的多对多关系 |

所有统计相关字段采用增量写入，避免重复遍历历史记录。

## 数据流
1. **命令执行**：执行器实时将输出写入日志文件；完成后通过 Registry 更新 `projects` 的统计字段，并向 `command_history` 追加记录。
2. **统计缓存**：定时或按需触发 `project_stats_cache` 生成过程，依据 `command_history` 聚合数据并存入 JSON 分布字段。
3. **搜索 / 报表**：CLI 优先查询数据库，如果需要查看完整输出，再根据 `log_file_path` 打开日志文件。

## 迁移策略
- 首次运行时检测 `projects`/`logcmd_entries` 是否存在，若发现旧表则执行迁移：复制记录、补齐统计字段、删除旧表。
- 所有迁移都以事务执行，失败自动回滚。
- `system_config` 记录当前版本号，便于后续增量脚本判断。

## 元数据规范
- 所有路径以绝对路径保存，避免同名冲突。
- 标签与自定义配置以 JSON 字段存储，便于新增属性。
- 时间统一使用 UTC 存储，展示时由业务层转换。

以上内容提供了数据库层需要遵循的边界与核心约束，其余实现细节通过代码注释维护。
