# LogCmd 数据库使用要点

本指南总结数据库能力在 CLI 中的核心使用场景，帮助开发者理解各模块职责与交互流程。

## 初始化
- `registry.New()` 是唯一入口：负责定位 `~/.logcmd/data/registry.db`、执行数据库迁移并返回连接句柄。
- CLI 启动时按需创建 Registry，后续模块（历史记录、统计缓存等）共享这一连接，避免重复打开数据库。

## 项目生命周期
1. 每次命令执行前，Logger 会调用 `registry.Register(logDir)`，确保 `.logcmd` 目录被注册并拥有唯一 ID。
2. Registry 维护项目的名称、标签、统计字段和最后检查时间；`project list/clean/delete` 命令全部依赖这些元数据。
3. Logger 根据执行结果调用 `registry.UpdateStats`，实时更新总命令数、成功率和最后执行信息。

## 命令历史
- History 管理器写入以下字段：项目 ID、命令名称与参数、起止时间、退出码、关联日志路径、标准输出/错误预览、运行环境信息。
- 查询接口支持按照时间范围、命令名称、状态、项目 ID、失败/成功等维度组合过滤，用于 CLI 的 future UI 或 API。

## 统计缓存
- Stats 模块中的 CacheManager 以日期为粒度缓存聚合数据：每日命令总数、成功率、平均/最大/最小时长，以及命令分布、退出码分布。
- 当 CLI 需要跨日期统计时，优先读取缓存；若缓存缺失，可触发后台生成流程并回填。

## 维护操作
- `registry.CheckAndCleanup()` 负责周期性清理不存在的项目目录，并刷新 `last_checked`。
- 历史和统计模块提供按日期或保留周期删除旧数据的能力，避免数据库无限增长。

## 命令行关联
- `logcmd search`/`stats`：跨项目操作先读取 Registry 列表，然后针对每个项目执行搜索或统计；不存在的项目会自动清理。
- `logcmd project`：呈现 Registry 中的核心字段（路径、名称、最后执行时间、成功率、命令数等）。
- `logcmd template`：依赖 Registry 记录的模板配置字段，将用户选择持久化。

以上内容勾勒了使用数据库层时需要遵循的主要流程。更细粒度的行为和参数说明保持在代码注释及接口定义中。
