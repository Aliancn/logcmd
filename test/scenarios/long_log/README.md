# 大文件输出性能测试

## 概述

本测试套件专门针对logcmd的大文件输出场景进行性能测试,确保在处理大量日志输出时系统的稳定性和性能表现。

## 测试场景

### 1. 小量输出性能基准 (100行)
- **目的**: 建立性能基准线
- **输出**: 100行简单文本
- **验证**: 日志文件创建成功,执行时间 < 1秒

### 2. 中等输出性能测试 (1000行)
- **目的**: 测试中等规模输出的性能
- **输出**: 1000行文本
- **验证**: 日志文件大小约13KB,记录完整

### 3. 大量输出性能测试 (10000行)
- **目的**: 测试大规模输出的处理能力
- **输出**: 10000行文本
- **验证**: 日志文件大小约139KB,记录完整

### 4. 超大量输出性能测试 (100000行)
- **目的**: 压力测试,验证极端场景下的稳定性
- **输出**: 100000行文本
- **验证**: 日志文件大小约1-2MB,系统稳定运行

### 5. 长文本行输出测试
- **目的**: 测试单行长文本的处理能力
- **输出**: 100行,每行1000个字符
- **验证**: 长文本正确记录,无截断

### 6. 混合输出测试 (stdout + stderr)
- **目的**: 验证同时捕获stdout和stderr的能力
- **输出**: 500行stdout + 500行stderr
- **验证**: 两种输出流都被正确记录

### 7. 快速连续命令测试
- **目的**: 测试快速连续执行多个命令的性能
- **操作**: 连续执行10个命令,每个输出100行
- **验证**: 所有命令的日志都被正确记录
- **注意**: 由于命令执行速度快,某些命令可能共享同一个日志文件

### 8. 性能回归检测
- **目的**: 监控性能回归,建立性能基准
- **操作**: 运行3次标准负载(1000行),计算平均执行时间
- **阈值**: 平均执行时间应 < 2秒
- **输出**: 显示每次运行的详细时间统计

## 性能指标

基于MacBook Pro (M系列芯片)的测试结果:

| 测试场景 | 输出行数 | 平均执行时间 | 文件大小 |
|---------|---------|------------|---------|
| 小量输出 | 100 | ~170ms | ~4KB |
| 中等输出 | 1,000 | ~60ms | ~13KB |
| 大量输出 | 10,000 | ~70ms | ~139KB |
| 超大量输出 | 100,000 | ~210ms | ~1MB |
| 长文本行 | 100 | ~60ms | ~100KB |
| 混合输出 | 1,000 | ~65ms | ~26KB |

## 运行测试

### 运行long_log测试套件
```bash
make test-scenarios-long-log
```

### 运行所有场景测试
```bash
make test-scenarios
```

## 测试环境

- **操作系统**: macOS / Linux
- **依赖**: Python3 (用于跨平台时间戳)
- **临时目录**: 自动创建和清理

## 技术细节

### 时间测量
为了确保跨平台兼容性,测试使用了自定义的时间戳函数:
- macOS: 使用Python3获取毫秒级时间戳
- Linux: 使用`date +%s%3N`获取毫秒级时间戳

### 日志验证
每个测试都会验证:
- 日志文件是否成功创建
- 文件大小是否符合预期
- 内容完整性(针对特定测试)
- 执行性能是否在可接受范围内

## 故障排查

### 测试失败
如果某个测试失败,请检查:
1. 磁盘空间是否充足
2. `/tmp`目录是否可写
3. Python3是否已安装(macOS)
4. logcmd二进制文件是否已编译

### 性能异常
如果性能测试失败:
1. 检查系统负载
2. 关闭其他占用IO的程序
3. 确保测试在本地磁盘而非网络存储上运行

## 扩展测试

可以通过修改测试脚本添加新的测试场景:
1. 修改`test_long_log.sh`
2. 添加新的测试函数
3. 在main函数中调用新测试
4. 运行测试验证

## 贡献

欢迎提交PR改进测试套件!
